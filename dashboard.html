<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaTrack - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fontawesome/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add notification sound -->
    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
</head>
<body>
    <div class="dashboard-container">
        <nav class="dashboard-nav">
            <div class="logo">
                <i class="fas fa-tint"></i>
                <h1>AquaTrack</h1>
            </div>
            <div class="user-info">
                <div class="user-profile" onclick="openProfileModal()">
                    <i class="fas fa-user-circle"></i>
                    <span id="userName"></span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <button onclick="logout()" class="btn-logout">Logout</button>
            </div>
        </nav>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Profile Settings</h2>
                    <button class="close-modal" onclick="closeProfileModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="profile-section">
                        <div class="profile-avatar">
                            <img id="profileImage" src="https://via.placeholder.com/150" alt="Profile Picture">
                            <button class="change-avatar" onclick="document.getElementById('avatarInput').click()">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="avatarInput" accept="image/*" style="display: none" onchange="updateProfileImage(event)">
                        </div>
                        <div class="profile-form">
                            <div class="form-group">
                                <label for="profileName">Full Name</label>
                                <input type="text" id="profileName" placeholder="Enter your name" required minlength="2" maxlength="50">
                                <span class="validation-message">Please enter a valid name (2-50 characters)</span>
                            </div>
                            <div class="form-group">
                                <label for="waterGoal">Daily Water Goal (ml)</label>
                                <input type="number" id="waterGoal" min="500" max="10000" step="100" placeholder="Enter your daily goal" required>
                                <span class="validation-message">Goal must be between 500ml and 10000ml</span>
                            </div>
                            <div class="form-group">
                                <label for="height">Height (cm)</label>
                                <input type="number" id="height" min="100" max="250" placeholder="Enter your height" required>
                                <span class="validation-message">Height must be between 100cm and 250cm</span>
                            </div>
                            <div class="form-group">
                                <label for="weight">Weight (kg)</label>
                                <input type="number" id="weight" min="30" max="200" placeholder="Enter your weight" required>
                                <span class="validation-message">Weight must be between 30kg and 200kg</span>
                            </div>
                            <div class="form-group">
                                <label for="activityLevel">Activity Level</label>
                                <select id="activityLevel" required>
                                    <option value="">Select activity level</option>
                                    <option value="sedentary">Sedentary</option>
                                    <option value="light">Lightly Active</option>
                                    <option value="moderate">Moderately Active</option>
                                    <option value="very">Very Active</option>
                                    <option value="extra">Extra Active</option>
                                </select>
                                <span class="validation-message">Please select an activity level</span>
                            </div>
                            <div class="form-group">
                                <label>Notification Settings</label>
                                <div class="toggle-group">
                                    <label class="toggle">
                                        <input type="checkbox" id="soundToggle" checked>
                                        <span class="toggle-slider"></span>
                                        Sound Notifications
                                    </label>
                                    <label class="toggle">
                                        <input type="checkbox" id="browserToggle" checked>
                                        <span class="toggle-slider"></span>
                                        Browser Notifications
                                    </label>
                                    <label class="toggle">
                                        <input type="checkbox" id="reminderToggle" checked>
                                        <span class="toggle-slider"></span>
                                        Daily Reminders
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Theme</label>
                                <select id="themeSelect">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="system">System Default</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-save" onclick="saveProfileSettings()">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Add new modals after the profile modal -->
        <div id="achievementsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Achievements</h2>
                    <button class="close-modal" onclick="closeModal('achievementsModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="achievements-grid" id="achievementsGrid">
                        <!-- Achievements will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <div id="statsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Advanced Statistics</h2>
                    <button class="close-modal" onclick="closeModal('statsModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3><i class="fas fa-chart-line"></i> Weekly Overview</h3>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 15%
                            </div>
                            <div class="stat-chart">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-clock"></i> Best Time of Day</h3>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 8%
                            </div>
                            <div class="stat-chart">
                                <canvas id="timeOfDayChart"></canvas>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-calendar-alt"></i> Monthly Progress</h3>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i> 12%
                            </div>
                            <div class="stat-chart">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-trophy"></i> Consistency Score</h3>
                            <div class="consistency-meter">
                                <div class="meter-fill" id="consistencyMeter"></div>
                                <span id="consistencyScore">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tipsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Daily Tips & Insights</h2>
                    <button class="close-modal" onclick="closeModal('tipsModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="tips-container">
                        <div class="tip-card active" id="currentTip">
                            <!-- Current tip will be shown here -->
                        </div>
                        <div class="tip-navigation">
                            <button onclick="previousTip()" class="btn-nav">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="nextTip()" class="btn-nav">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main class="dashboard-main">
            <!-- Update the features bar -->
            <div class="features-bar">
                <div class="feature-item" onclick="openModal('achievementsModal')" data-tooltip="View your achievements">
                    <i class="fas fa-trophy"></i>
                    <span>Achievements</span>
                    <span class="badge" id="achievementCount">0</span>
                </div>
                <div class="feature-item" onclick="openModal('statsModal')" data-tooltip="View detailed statistics">
                    <i class="fas fa-chart-line"></i>
                    <span>Statistics</span>
                </div>
                <div class="feature-item" onclick="openModal('tipsModal')" data-tooltip="Get daily tips">
                    <i class="fas fa-lightbulb"></i>
                    <span>Tips</span>
                </div>
                <div class="feature-item" onclick="toggleTheme()" data-tooltip="Change theme">
                    <i class="fas fa-palette"></i>
                    <span>Theme</span>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Water Tracking Section -->
                <div class="dashboard-card water-tracker">
                    <h2>Today's Water Intake</h2>
                    <div class="progress-container">
                        <div class="water-stats">
                            <span id="waterAmount">0</span>/<span id="waterGoal">2000</span> ml
                        </div>
                        <div class="chart-container">
                            <canvas id="waterProgressChart"></canvas>
                        </div>
                        <div id="additionalWaterContainer" class="additional-water-container" style="display: none;">
                            <div class="water-stats additional">
                                Additional Intake: <span id="additionalWater">0</span> ml
                            </div>
                            <div class="chart-container">
                                <canvas id="additionalWaterChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="add-water">
                        <input type="number" id="waterInput" placeholder="Enter amount in ml" min="0">
                        <button onclick="addWater()" class="btn-add">Add Water</button>
                    </div>
                    <div id="waterLimitMessage" class="water-limit-message"></div>
                </div>

                <!-- Daily Stats Section -->
                <div class="dashboard-card stats">
                    <h2>Daily Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <i class="fas fa-glass-water"></i>
                            <div class="stat-info">
                                <span class="stat-value" id="todayIntake">0</span>
                                <span class="stat-label">Today's Intake</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-calendar-check"></i>
                            <div class="stat-info">
                                <span class="stat-value" id="goalCompletion">0%</span>
                                <span class="stat-label">Goal Completion</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-clock"></i>
                            <div class="stat-info">
                                <span class="stat-value" id="lastDrink">-</span>
                                <span class="stat-label">Last Drink</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reminders Section -->
                <div class="dashboard-card reminders">
                    <h2>Water Reminders</h2>
                    <div class="reminder-list" id="reminderList">
                        <!-- Reminders will be added here dynamically -->
                    </div>
                    <div class="add-reminder">
                        <input type="time" id="reminderTime">
                        <button onclick="addReminder()" class="btn-add">Add Reminder</button>
                    </div>
                </div>

                <!-- History Section -->
                <div class="dashboard-card history">
                    <h2>Drinking History</h2>
                    <div class="history-list" id="historyList">
                        <!-- History table will be added here dynamically by loadHistory -->
                    </div>
                    <button class="btn-export">Export Report (PDF)</button>
                </div>

                <!-- Water Intake Chart Section -->
                <div class="dashboard-card chart">
                    <h2>Water Intake Distribution</h2>
                    <div class="chart-container">
                        <canvas id="waterIntakeChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add this before the closing body tag -->
    <div id="pdfContainer" class="pdf-container">
        <div class="pdf-header">
            <h1>Water Intake Report</h1>
            <p id="pdfDate"></p>
            <div class="pdf-user-info">
                <p>Generated for: <span id="pdfUserName"></span></p>
                <p>Daily Goal: <span id="pdfUserGoal"></span> ml</p>
            </div>
        </div>

        <div class="pdf-section">
            <h2>Daily Summary</h2>
            <div class="pdf-stats">
                <div class="pdf-stat-item">
                    <div class="pdf-stat-value" id="pdfWaterAmount">0</div>
                    <div class="pdf-stat-label">Today's Intake</div>
                </div>
                <div class="pdf-stat-item">
                    <div class="pdf-stat-value" id="pdfGoalCompletion">0%</div>
                    <div class="pdf-stat-label">Goal Completion</div>
                </div>
                <div class="pdf-stat-item">
                    <div class="pdf-stat-value" id="pdfConsistencyScore">0%</div>
                    <div class="pdf-stat-label">Consistency Score</div>
                </div>
            </div>
        </div>

        <div class="pdf-section">
            <h2>Weekly Overview</h2>
            <div class="pdf-weekly-stats">
                <div class="pdf-stat-item">
                    <div class="pdf-stat-value" id="pdfWeeklyAverage">0</div>
                    <div class="pdf-stat-label">Weekly Average</div>
                </div>
                <div class="pdf-stat-item">
                    <div class="pdf-stat-value" id="pdfBestDay">0</div>
                    <div class="pdf-stat-label">Best Day</div>
                </div>
                <div class="pdf-stat-item">
                    <div class="pdf-stat-value" id="pdfCompletionRate">0%</div>
                    <div class="pdf-stat-label">Goal Completion Rate</div>
                </div>
            </div>
            <div class="pdf-chart" id="pdfWeeklyChart"></div>
        </div>

        <div class="pdf-section">
            <h2>Intake History</h2>
            <table class="pdf-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Goal</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="pdfHistoryTable">
                </tbody>
            </table>
        </div>

        <div class="pdf-section">
            <h2>Time Distribution</h2>
            <div class="pdf-time-distribution">
                <div class="pdf-time-block">
                    <h3>Morning (6-12)</h3>
                    <div class="pdf-stat-value" id="pdfMorningIntake">0</div>
                    <div class="pdf-stat-label">ml</div>
                </div>
                <div class="pdf-time-block">
                    <h3>Afternoon (12-18)</h3>
                    <div class="pdf-stat-value" id="pdfAfternoonIntake">0</div>
                    <div class="pdf-stat-label">ml</div>
                </div>
                <div class="pdf-time-block">
                    <h3>Evening (18-22)</h3>
                    <div class="pdf-stat-value" id="pdfEveningIntake">0</div>
                    <div class="pdf-stat-label">ml</div>
                </div>
                <div class="pdf-time-block">
                    <h3>Night (22-6)</h3>
                    <div class="pdf-stat-value" id="pdfNightIntake">0</div>
                    <div class="pdf-stat-label">ml</div>
                </div>
            </div>
            <div class="pdf-chart" id="pdfTimeChart"></div>
        </div>

        <div class="pdf-section">
            <h2>Achievements & Insights</h2>
            <div class="pdf-achievements">
                <div class="pdf-achievement-item">
                    <h3>Current Streak</h3>
                    <div class="pdf-stat-value" id="pdfCurrentStreak">0</div>
                    <div class="pdf-stat-label">days</div>
                </div>
                <div class="pdf-achievement-item">
                    <h3>Longest Streak</h3>
                    <div class="pdf-stat-value" id="pdfLongestStreak">0</div>
                    <div class="pdf-stat-label">days</div>
                </div>
                <div class="pdf-achievement-item">
                    <h3>Total Achievements</h3>
                    <div class="pdf-stat-value" id="pdfTotalAchievements">0</div>
                    <div class="pdf-stat-label">unlocked</div>
                </div>
            </div>
        </div>

        <div class="pdf-section">
            <h2>Recommendations</h2>
            <div class="pdf-recommendations" id="pdfRecommendations">
                <!-- Recommendations will be added dynamically -->
            </div>
        </div>

        <div class="pdf-footer">
            <p>Generated by Aqua - Your Water Tracking Assistant</p>
            <p class="pdf-footer-note">This report is based on your water intake data and personal goals.</p>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // Display user name
            document.getElementById('userName').textContent = currentUser.fullname;
            
            // Load all data
            loadWaterData();
            loadReminders();
            loadHistory();
        });

        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Water tracking functions
        function loadWaterData() {
            const waterData = JSON.parse(localStorage.getItem('waterData')) || {
                today: new Date().toDateString(),
                amount: 0,
                additionalAmount: 0,
                goal: 2000,
                history: []
            };

            // Reset if it's a new day
            if (waterData.today !== new Date().toDateString()) {
                waterData.today = new Date().toDateString();
                waterData.amount = 0;
                waterData.additionalAmount = 0;
                waterData.history = [];
            }

            updateWaterDisplay(waterData);
            updateWaterChart();
        }

        function addWater() {
            const input = document.getElementById('waterInput');
            const amount = parseInt(input.value);
            const waterLimitMessage = document.getElementById('waterLimitMessage');
            
            if (isNaN(amount) || amount <= 0) {
                waterLimitMessage.textContent = 'Please enter a valid amount';
                waterLimitMessage.className = 'water-limit-message error';
                return;
            }

            const waterData = JSON.parse(localStorage.getItem('waterData')) || {
                today: new Date().toDateString(),
                amount: 0,
                additionalAmount: 0,
                goal: 2000,
                history: []
            };

            const now = new Date();
            const totalAmount = waterData.amount + amount;

            if (totalAmount <= waterData.goal) {
                waterData.amount = totalAmount;
                waterLimitMessage.textContent = '';
                waterLimitMessage.className = 'water-limit-message';
            } else {
                const excessAmount = totalAmount - waterData.goal;
                waterData.amount = waterData.goal;
                waterData.additionalAmount = (waterData.additionalAmount || 0) + excessAmount;
                waterLimitMessage.textContent = `Goal achieved! Additional ${excessAmount}ml recorded.`;
                waterLimitMessage.className = 'water-limit-message success';
                showNotification('Goal Achieved! üéâ', `You've reached your daily water intake goal!`);
            }

            waterData.history.push({
                amount,
                time: now.toLocaleTimeString(),
                timestamp: now.getTime()
            });

            localStorage.setItem('waterData', JSON.stringify(waterData));
            
            updateWaterDisplay(waterData);
            loadHistory();
            input.value = '';
            updateWaterChart();
        }

        function updateWaterDisplay(waterData) {
            const progress = (waterData.amount / waterData.goal) * 100;
            
            // Update water amount display
            const waterAmount = document.getElementById('waterAmount');
            waterAmount.textContent = waterData.amount;
            waterAmount.classList.add('updated');
            setTimeout(() => waterAmount.classList.remove('updated'), 500);
            
            document.getElementById('waterGoal').textContent = waterData.goal;
            document.getElementById('todayIntake').textContent = waterData.amount + ' ml';
            
            // Update progress chart
            updateProgressChart(waterData);
            
            // Update additional water display if exists
            const additionalContainer = document.getElementById('additionalWaterContainer');
            if (waterData.additionalAmount > 0) {
                additionalContainer.style.display = 'block';
                document.getElementById('additionalWater').textContent = waterData.additionalAmount;
                updateAdditionalWaterChart(waterData);
            } else {
                additionalContainer.style.display = 'none';
            }
            
            // Animate goal completion
            const goalCompletion = document.getElementById('goalCompletion');
            goalCompletion.textContent = Math.min(Math.round(progress), 100) + '%';
            if (progress >= 100) {
                goalCompletion.classList.add('achieved');
            } else {
                goalCompletion.classList.remove('achieved');
            }
            
            if (waterData.history.length > 0) {
                const lastDrink = waterData.history[waterData.history.length - 1];
                document.getElementById('lastDrink').textContent = lastDrink.time;
            }
        }

        // Add new function for progress chart
        function updateProgressChart(waterData) {
            const ctx = document.getElementById('waterProgressChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.progressChart) {
                window.progressChart.destroy();
            }

            const progress = (waterData.amount / waterData.goal) * 100;
            const remaining = 100 - progress;

            window.progressChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Progress'],
                    datasets: [
                        {
                            label: 'Water Intake',
                            data: [progress],
                            backgroundColor: '#4CAF50',
                            borderRadius: 5,
                            borderWidth: 0
                        },
                        {
                            label: 'Remaining',
                            data: [remaining],
                            backgroundColor: '#E0E0E0',
                            borderRadius: 5,
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return `${value.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            max: 100,
                            display: false
                        },
                        y: {
                            stacked: true,
                            display: false
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Add new function for additional water chart
        function updateAdditionalWaterChart(waterData) {
            const ctx = document.getElementById('additionalWaterChart').getContext('2d');
            
            if (window.additionalWaterChart) {
                window.additionalWaterChart.destroy();
            }

            window.additionalWaterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Additional Intake'],
                    datasets: [{
                        label: 'Additional Water',
                        data: [waterData.additionalAmount],
                        backgroundColor: '#2196F3',
                        borderRadius: 5,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw}ml`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Reminder functions
        function loadReminders() {
            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            const reminderList = document.getElementById('reminderList');
            reminderList.innerHTML = '';

            reminders.forEach((reminder, index) => {
                const reminderElement = document.createElement('div');
                reminderElement.className = 'reminder-item new';
                reminderElement.innerHTML = `
                    <div class="reminder-time">
                        <i class="fas fa-bell"></i>
                        <span>${reminder.time}</span>
                    </div>
                    <i class="fas ${reminder.sound ? 'fa-volume-up' : 'fa-volume-mute'} sound-indicator" 
                       onclick="toggleReminderSound(${index})" 
                       title="${reminder.sound ? 'Sound enabled' : 'Sound disabled'}"></i>
                    <button onclick="deleteReminder(${index})" class="btn-delete">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                reminderList.appendChild(reminderElement);
                
                // Remove the 'new' class after animation
                setTimeout(() => {
                    reminderElement.classList.remove('new');
                }, 500);
            });

            // Check for due reminders
            checkDueReminders();
        }

        function addReminder() {
            const timeInput = document.getElementById('reminderTime');
            const time = timeInput.value;
            
            if (!time) {
                showNotification('Error', 'Please select a time', 'error');
                return;
            }

            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            reminders.push({ time, sound: true }); // Add sound property
            localStorage.setItem('reminders', JSON.stringify(reminders));
            
            showNotification('Reminder Set! ‚è∞', `Water reminder set for ${time}`);
            loadReminders();
            timeInput.value = '';
        }

        function toggleReminderSound(index) {
            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            reminders[index].sound = !reminders[index].sound;
            localStorage.setItem('reminders', JSON.stringify(reminders));
            loadReminders();
        }

        function checkDueReminders() {
            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            const now = new Date();
            const currentTime = now.getHours() + ':' + now.getMinutes();

            reminders.forEach((reminder, index) => {
                if (reminder.time === currentTime && reminder.sound) {
                    playReminderSound();
                    showNotification('Water Reminder! üíß', 'Time to drink water!');
                }
            });
        }

        function playReminderSound() {
            const audio = document.getElementById('notificationSound');
            audio.play();
        }

        function deleteReminder(index) {
            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            reminders.splice(index, 1);
            localStorage.setItem('reminders', JSON.stringify(reminders));
            loadReminders();
        }

        // History functions
        function loadHistory() {
            const waterData = JSON.parse(localStorage.getItem('waterData')) || {
                history: []
            };
            const historyList = document.getElementById('historyList');
            // Clear the existing history list content
            historyList.innerHTML = '';

            // Create the table structure
            const historyTable = document.createElement('table');
            historyTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Total (ml)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- History rows will go here -->
                </tbody>
            `;

            const tbody = historyTable.querySelector('tbody');

            // Aggregate history by date and display last 7 days
            const dailyIntake = waterData.history.reduce((acc, entry) => {
                const date = new Date(entry.timestamp).toDateString();
                if (!acc[date]) {
                    acc[date] = 0;
                }
                acc[date] += entry.amount;
                return acc;
            }, {});

            const sortedDates = Object.keys(dailyIntake).sort((a, b) => new Date(b) - new Date(a));

            // Display the last 7 days or fewer if less data is available
            const last7DaysDates = sortedDates.slice(0, 7);

            last7DaysDates.forEach(dateString => {
                const totalAmount = dailyIntake[dateString];
                const goal = JSON.parse(localStorage.getItem('waterData')).goal || 2000; // Get the goal from localStorage
                const status = totalAmount >= goal ? 'Goal Achieved' : 'Needs Improvement';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(dateString).toLocaleDateString()}</td>
                    <td>${totalAmount} ml</td>
                    <td class="status-${status.toLowerCase().replace(' ', '-')}">${status}</td>
                `;
                tbody.appendChild(row);
            });

            // Append the table to the historyList div
            historyList.appendChild(historyTable);
        }

        // Function to handle exporting data
        function exportHistory() {
            const waterData = JSON.parse(localStorage.getItem('waterData')) || {
                history: []
            };

            const dailyIntake = waterData.history.reduce((acc, entry) => {
                const date = new Date(entry.timestamp).toDateString();
                if (!acc[date]) {
                    acc[date] = 0;
                }
                acc[date] += entry.amount;
                return acc;
            }, {});

            const sortedDates = Object.keys(dailyIntake).sort((a, b) => new Date(b) - new Date(a));
            const last7DaysDates = sortedDates.slice(0, 7);
            const goal = JSON.parse(localStorage.getItem('waterData')).goal || 2000; // Get the goal from localStorage

            let csvContent = "Date,Total (ml),Status\n"; // CSV header

            last7DaysDates.forEach(dateString => {
                const totalAmount = dailyIntake[dateString];
                const status = totalAmount >= goal ? 'Goal Achieved' : 'Needs Improvement';
                const formattedDate = new Date(dateString).toLocaleDateString();
                csvContent += `${formattedDate},${totalAmount},${status}\n`;
            });

            // Create a Blob with the CSV data
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            // Create a download link
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'aquatrack_history.csv');
            link.style.visibility = 'hidden'; // Hide the link

            // Append to body and trigger click
            document.body.appendChild(link);
            link.click();

            // Clean up
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Free up memory
        }

        // Chart functions
        function updateWaterChart() {
            const chartContainer = document.querySelector('.chart-container');
            chartContainer.classList.add('loading');
            
            const waterData = JSON.parse(localStorage.getItem('waterData')) || {
                history: []
            };

            // Group water intake by hour
            const hourlyData = new Array(24).fill(0);
            waterData.history.forEach(entry => {
                const hour = new Date(entry.timestamp).getHours();
                hourlyData[hour] += entry.amount;
            });

            // Create labels for hours
            const labels = hourlyData.map((_, index) => `${index}:00`);

            // Create the chart
            const ctx = document.getElementById('waterIntakeChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.waterChart) {
                window.waterChart.destroy();
            }

            window.waterChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: hourlyData,
                        backgroundColor: [
                            '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B',
                            '#FFC107', '#FF9800', '#FF5722', '#795548',
                            '#9E9E9E', '#607D8B', '#2196F3', '#3F51B5',
                            '#673AB7', '#9C27B0', '#E91E63', '#F44336',
                            '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B',
                            '#FFC107', '#FF9800', '#FF5722', '#795548'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12
                            }
                        },
                        title: {
                            display: true,
                            text: 'Water Intake by Hour'
                        }
                    }
                }
            });

            // Remove loading class after chart is rendered
            setTimeout(() => {
                chartContainer.classList.remove('loading');
            }, 500);
        }

        // Check for notification permission
        function checkNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support notifications");
                return;
            }
            
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // Play notification sound
        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            audio.play();
        }

        // Show notification
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                </div>
                <div class="notification-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }

        // Add new functions for profile management
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'flex';
            loadProfileSettings();
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'none';
        }

        function loadProfileSettings() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const waterData = JSON.parse(localStorage.getItem('waterData')) || { goal: 2000 };
            const profileImage = localStorage.getItem('profileImage');
            
            if (profileImage) {
                document.getElementById('profileImage').src = profileImage;
            }
            
            document.getElementById('profileName').value = currentUser.fullname;
            document.getElementById('waterGoal').value = waterData.goal;
            document.getElementById('height').value = currentUser.height || '';
            document.getElementById('weight').value = currentUser.weight || '';
            document.getElementById('activityLevel').value = currentUser.activityLevel || 'moderate';
            document.getElementById('soundToggle').checked = currentUser.soundNotifications !== false;
            document.getElementById('browserToggle').checked = currentUser.browserNotifications !== false;
            document.getElementById('reminderToggle').checked = currentUser.dailyReminders !== false;
            document.getElementById('themeSelect').value = localStorage.getItem('theme') || 'light';
        }

        function saveProfileSettings() {
            if (!validateForm()) {
                showNotification('Validation Error', 'Please fill in all required fields correctly', 'error');
                return;
            }

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const waterData = JSON.parse(localStorage.getItem('waterData')) || { goal: 2000 };
            
            // Update user data with validation
            const newName = document.getElementById('profileName').value.trim();
            if (newName.length < 2 || newName.length > 50) {
                showNotification('Invalid Name', 'Name must be between 2 and 50 characters', 'error');
                return;
            }
            currentUser.fullname = newName;

            // Validate and update water goal
            const newGoal = parseInt(document.getElementById('waterGoal').value);
            if (newGoal < 500 || newGoal > 10000) {
                showNotification('Invalid Goal', 'Water goal must be between 500ml and 10000ml', 'error');
                return;
            }
            waterData.goal = newGoal;

            // Validate and update height
            const height = parseInt(document.getElementById('height').value);
            if (height < 100 || height > 250) {
                showNotification('Invalid Height', 'Height must be between 100cm and 250cm', 'error');
                return;
            }
            currentUser.height = height;

            // Validate and update weight
            const weight = parseInt(document.getElementById('weight').value);
            if (weight < 30 || weight > 200) {
                showNotification('Invalid Weight', 'Weight must be between 30kg and 200kg', 'error');
                return;
            }
            currentUser.weight = weight;

            // Update other settings
            currentUser.activityLevel = document.getElementById('activityLevel').value;
            currentUser.soundNotifications = document.getElementById('soundToggle').checked;
            currentUser.browserNotifications = document.getElementById('browserToggle').checked;
            currentUser.dailyReminders = document.getElementById('reminderToggle').checked;
            
            const theme = document.getElementById('themeSelect').value;
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            } else {
                document.body.setAttribute('data-theme', theme);
            }
            localStorage.setItem('theme', theme);
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('waterData', JSON.stringify(waterData));
            
            document.getElementById('userName').textContent = currentUser.fullname;
            updateWaterDisplay(waterData);
            closeProfileModal();
            
            showNotification('Profile Updated', 'Your profile settings have been saved successfully!', 'success');
        }

        // Add system theme detection
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (localStorage.getItem('theme') === 'system') {
                document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // Add new functions for enhanced features
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            if (modalId === 'achievementsModal') {
                loadAchievements();
            } else if (modalId === 'statsModal') {
                loadAdvancedStats();
            } else if (modalId === 'tipsModal') {
                loadDailyTip();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function loadAchievements() {
            const achievements = [
                { id: 'first_goal', title: 'First Goal', description: 'Reach your daily goal for the first time', icon: 'üéØ' },
                { id: 'streak_3', title: '3-Day Streak', description: 'Maintain your goal for 3 consecutive days', icon: 'üî•' },
                { id: 'streak_7', title: 'Week Warrior', description: 'Maintain your goal for 7 consecutive days', icon: 'üèÜ' },
                { id: 'streak_30', title: 'Monthly Master', description: 'Maintain your goal for 30 consecutive days', icon: 'üëë' },
                { id: 'overachiever', title: 'Overachiever', description: 'Exceed your goal by 50%', icon: '‚≠ê' },
                { id: 'early_bird', title: 'Early Bird', description: 'Complete 50% of your goal before noon', icon: 'üåÖ' },
                { id: 'night_owl', title: 'Night Owl', description: 'Complete your goal after 8 PM', icon: 'ü¶â' },
                { id: 'perfect_week', title: 'Perfect Week', description: 'Achieve your goal every day for a week', icon: 'üìÖ' },
                { id: 'water_master', title: 'Water Master', description: 'Track water intake for 100 days', icon: 'üíß' },
                { id: 'quick_starter', title: 'Quick Starter', description: 'Drink 500ml within first hour of waking', icon: '‚ö°' },
                { id: 'consistency_king', title: 'Consistency King', description: 'Maintain 90% goal completion for a month', icon: 'üëë' },
                { id: 'social_butterfly', title: 'Social Butterfly', description: 'Share your progress 5 times', icon: 'ü¶ã' }
            ];

            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';

            achievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = 'achievement-card';
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <h3>${achievement.title}</h3>
                    <p>${achievement.description}</p>
                    <div class="achievement-progress">
                        <div class="progress-bar">
                            <div class="progress" style="width: ${Math.random() * 100}%"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            updateAchievementCount();
        }

        function loadAdvancedStats() {
            const waterData = JSON.parse(localStorage.getItem('waterData')) || { history: [] };
            
            // Weekly Overview Chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Water Intake (ml)',
                        data: generateWeeklyData(waterData),
                        backgroundColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw}ml`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Milliliters (ml)'
                            }
                        }
                    }
                }
            });

            // Time of Day Chart
            const timeCtx = document.getElementById('timeOfDayChart').getContext('2d');
            new Chart(timeCtx, {
                type: 'radar',
                data: {
                    labels: ['Morning (6-12)', 'Afternoon (12-18)', 'Evening (18-22)', 'Night (22-6)'],
                    datasets: [{
                        label: 'Intake Distribution',
                        data: generateTimeOfDayData(waterData),
                        backgroundColor: 'rgba(33, 150, 243, 0.2)',
                        borderColor: '#2196F3',
                        pointBackgroundColor: '#2196F3',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });

            // Add Monthly Progress Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: generateMonthLabels(),
                    datasets: [{
                        label: 'Daily Average',
                        data: generateMonthlyData(waterData),
                        borderColor: '#2196F3',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(33, 150, 243, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Intake (ml)'
                            }
                        }
                    }
                }
            });

            // Update Consistency Score
            const consistency = calculateConsistency(waterData);
            document.getElementById('consistencyMeter').style.width = `${consistency}%`;
            document.getElementById('consistencyScore').textContent = `${consistency}%`;

            // Update Additional Stats
            updateAdditionalStats(waterData);
        }

        function loadDailyTip() {
            const tips = [
                {
                    title: "Morning Hydration",
                    content: "Start your day with a glass of water to kickstart your metabolism and rehydrate after sleep.",
                    icon: "üåÖ"
                },
                {
                    title: "Smart Tracking",
                    content: "Use the app's reminder feature to maintain consistent water intake throughout the day.",
                    icon: "üì±"
                },
                {
                    title: "Flavor Boost",
                    content: "Add fruits like lemon, cucumber, or berries to your water for a refreshing twist.",
                    icon: "üçã"
                }
            ];

            const currentTip = document.getElementById('currentTip');
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            
            currentTip.innerHTML = `
                <div class="tip-icon">${randomTip.icon}</div>
                <h3>${randomTip.title}</h3>
                <p>${randomTip.content}</p>
            `;
        }

        function generateWeeklyData(waterData) {
            // Generate sample data for the week
            return Array(7).fill(0).map(() => Math.floor(Math.random() * 2000) + 500);
        }

        function generateTimeOfDayData(waterData) {
            // Generate sample data for time of day distribution
            return [
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100)
            ];
        }

        function calculateConsistency(waterData) {
            // Calculate consistency score based on goal completion
            return Math.floor(Math.random() * 100);
        }

        function updateAchievementCount() {
            const count = document.querySelectorAll('.achievement-card .progress').length;
            document.getElementById('achievementCount').textContent = count;
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Add new helper functions for statistics
        function generateMonthLabels() {
            const labels = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            return labels;
        }

        function generateMonthlyData(waterData) {
            // Generate sample monthly data
            return Array(30).fill(0).map(() => Math.floor(Math.random() * 1000) + 1000);
        }

        function updateAdditionalStats(waterData) {
            const stats = {
                totalIntake: calculateTotalIntake(waterData),
                averageIntake: calculateAverageIntake(waterData),
                bestDay: findBestDay(waterData),
                completionRate: calculateCompletionRate(waterData),
                currentStreak: calculateStreak(waterData),
                longestStreak: calculateLongestStreak(waterData),
                mostActiveHour: findMostActiveHour(waterData),
                consistencyScore: calculateConsistency(waterData)
            };

            // Update stats display
            document.getElementById('totalIntake').textContent = `${stats.totalIntake}ml`;
            document.getElementById('averageIntake').textContent = `${stats.averageIntake}ml`;
            document.getElementById('bestDay').textContent = `${stats.bestDay}ml`;
            document.getElementById('completionRate').textContent = `${stats.completionRate}%`;
            document.getElementById('currentStreak').textContent = `${stats.currentStreak} days`;
            document.getElementById('longestStreak').textContent = `${stats.longestStreak} days`;
            document.getElementById('mostActiveHour').textContent = stats.mostActiveHour;
        }

        // Add mobile-specific enhancements
        function enhanceMobileExperience() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Add touch-friendly classes
                document.querySelectorAll('.feature-item, .btn-add, .btn-export').forEach(element => {
                    element.classList.add('touch-friendly');
                });

                // Enhance scrolling
                document.querySelectorAll('.modal-body').forEach(element => {
                    element.style.webkitOverflowScrolling = 'touch';
                });

                // Adjust chart sizes for mobile
                const charts = document.querySelectorAll('canvas');
                charts.forEach(chart => {
                    chart.style.maxHeight = '200px';
                });
            }
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            // Existing initializations
            checkNotificationPermission();
            loadWaterData();
            loadReminders();
            loadHistory();
            showStreak();

            // Add mobile enhancements
            enhanceMobileExperience();
            
            // Add resize listener for responsive adjustments
            window.addEventListener('resize', enhanceMobileExperience);
        });

        function updateProfileImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImage').src = e.target.result;
                    localStorage.setItem('profileImage', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        // Add form validation functions
        function validateForm() {
            const formGroups = document.querySelectorAll('.form-group');
            let isValid = true;

            formGroups.forEach(group => {
                const input = group.querySelector('input, select');
                if (input.required) {
                    if (!input.value) {
                        input.classList.add('invalid');
                        isValid = false;
                    } else {
                        input.classList.remove('invalid');
                    }
                }
            });

            return isValid;
        }

        // Add input validation listeners
        document.querySelectorAll('.form-group input, .form-group select').forEach(input => {
            input.addEventListener('input', function() {
                if (this.validity.valid) {
                    this.classList.remove('invalid');
                    this.classList.add('valid');
                } else {
                    this.classList.remove('valid');
                    this.classList.add('invalid');
                }
            });
        });

        // Add helper functions for PDF generation and stats (moved here to be before generatePDF)
        function calculateStreak(waterData) {
            // Calculate streak
            // ... existing code ...
        }

        function calculateLongestStreak(waterData) {
            // Calculate longest streak
            // ... existing code ...
        }

        function calculateWeeklyStats(waterData) {
            // Calculate weekly statistics
            // ... existing code ...
        }

        function calculateTimeDistribution(waterData) {
            // Calculate time distribution
            // ... existing code ...
        }

        function generateNotes(entry) {
            // Generate notes
            // ... existing code ...
        }

        function generateRecommendations(waterData) {
            // Generate recommendations
            // ... existing code ...
        }

        function updatePDFCharts(waterData) {
            // Update weekly chart
            // ... existing code ...
        }

        // Update the export button click handler
        document.querySelector('.btn-export').addEventListener('click', generatePDF);

        function generatePDF() {
            // Update PDF content
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const waterData = JSON.parse(localStorage.getItem('waterData')) || { goal: 2000 };
            
            document.getElementById('pdfDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('pdfUserName').textContent = currentUser.fullname;
            document.getElementById('pdfUserGoal').textContent = waterData.goal;
            
            // Update daily summary
            document.getElementById('pdfWaterAmount').textContent = document.getElementById('waterAmount').textContent + ' ml';
            document.getElementById('pdfGoalCompletion').textContent = document.getElementById('goalCompletion').textContent;
            document.getElementById('pdfConsistencyScore').textContent = document.getElementById('consistencyScore').textContent + '%';

            // Update weekly stats
            const weeklyStats = calculateWeeklyStats(waterData);
            document.getElementById('pdfWeeklyAverage').textContent = weeklyStats.average + ' ml';
            document.getElementById('pdfBestDay').textContent = weeklyStats.bestDay + ' ml';
            document.getElementById('pdfCompletionRate').textContent = weeklyStats.completionRate + '%';

            // Update time distribution
            const timeDistribution = calculateTimeDistribution(waterData);
            document.getElementById('pdfMorningIntake').textContent = timeDistribution.morning + ' ml';
            document.getElementById('pdfAfternoonIntake').textContent = timeDistribution.afternoon + ' ml';
            document.getElementById('pdfEveningIntake').textContent = timeDistribution.evening + ' ml';
            document.getElementById('pdfNightIntake').textContent = timeDistribution.night + ' ml';

            // Update achievements
            document.getElementById('pdfCurrentStreak').textContent = calculateStreak(waterData);
            document.getElementById('pdfLongestStreak').textContent = calculateLongestStreak(waterData);
            document.getElementById('pdfTotalAchievements').textContent = document.querySelectorAll('.achievement-card .progress').length;

            // Update history table
            const historyTable = document.getElementById('pdfHistoryTable');
            historyTable.innerHTML = '';
            const historyData = JSON.parse(localStorage.getItem('waterHistory') || '[]');
            
            historyData.slice(-7).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(entry.date).toLocaleDateString()}</td>
                    <td>${entry.amount} ml</td>
                    <td>${entry.goal} ml</td>
                    <td>${entry.amount >= entry.goal ? 'Achieved' : 'In Progress'}</td>
                    <td>${generateNotes(entry)}</td>
                `;
                historyTable.appendChild(row);
            });

            // Add recommendations
            const recommendations = generateRecommendations(waterData);
            const recommendationsContainer = document.getElementById('pdfRecommendations');
            recommendationsContainer.innerHTML = recommendations.map(rec => `
                <div class="pdf-recommendation-item">
                    <i class="fas ${rec.icon}"></i>
                    <div class="pdf-recommendation-content">
                        <h4>${rec.title}</h4>
                        <p>${rec.content}</p>
                    </div>
                </div>
            `).join('');

            // Clone and update charts
            updatePDFCharts(waterData);

            // Show the PDF container
            const pdfContainer = document.getElementById('pdfContainer');
            pdfContainer.style.display = 'block';

            // Generate PDF
            const opt = {
                margin: 1,
                filename: 'water-intake-report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(pdfContainer).save().then(() => {
                pdfContainer.style.display = 'none';
            });
        }
    </script>
</body>
</html> 